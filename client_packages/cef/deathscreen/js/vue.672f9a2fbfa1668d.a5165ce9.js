"use strict";(self["webpackChunkcef"]=self["webpackChunkcef"]||[]).push([[1475],{63255:function(t,e,a){var i=a(33907),o=a(56001),n=a(16837),s=a(53517),r=a(4433),l=a(19629),d=a(91738),c=a(98464),p=a(42860),f=a(84602),u=a(6767),h=a.n(u),m=a(85445),y=a(18142),g=a(50007),b=a(62238),Z=a(15278),M=a(39319),v=a(53196),D=a(78221);const C=[702,703,701];e.Z={name:"captureMap",components:{NotificationsModal:o.Z,SetCaptureModal:n.Z,AttackModal:s.Z,BroadcastModal:r.Z,SetCapturePage:c.Z,ScheduleListPage:p.Z,LogsPage:f.Z,pageHeader:b.Z,ConfigureZoneModal:l.Z},mixins:[d.Z],mounted(){const t=this.$el.parentElement.getBoundingClientRect(),e=this.$el.getBoundingClientRect(),a=e.x-t.x,i=e.y-t.y;m.Z.mount(this.$refs.mapContainer,{offset:{x:a,y:i},centerMove:{x:-1616.53125,y:-4259.703125},zoomLevel:5}),m.Z.addListener("zoneClick",this.onZoneClick),m.Z.addListener("mapClick",this.onMapClick),m.Z.addListener("mapMove",this.onMapClick),m.Z.addListener("mapChangeZoomLevel",this.onMapClick),m.Z.addListener("zoneHovered",this.onZoneHovered),m.Z.updateMap(),m.Z.updateLabelsList([]),m.Z.updateZonesList([]),m.Z.setDataLoaded(!1),this.zonesGprah=null,this.fractionsZonesGraph={},m.Z.clearDynamicLabels(),this.updateZonesMap(3),this.secondInterval=setInterval(this.onSecond,1e3),m.Z.toggleLabelRendering(this.renderLabels),m.Z.updateMap(),v.TB.$on("clearBuilded",(()=>{this.familyZonesBuild={}})),v.TB.$on("updateZonesChunk",(t=>{if(this.isFamily)return this.processZonesUpdate(t)})),v.TB.$on("updateZone",(t=>{if(this.isFamily){for(const e of t)m.Z.updateZoneData(e);m.Z.updateMap()}})),v.TB.$on("cancelAttack",(t=>{2!=t.zoneSubtype&&m.Z.updateLabelColorById(`labelZone--${t.id}`,[...t.textColor]),m.Z.removeDynamicLabelById(`timeLabel-${t.id}`),m.Z.updateMap()})),this.onSecond(),this.isFamily&&this.processZonesUpdate(Object.values(this.zonesData)),mp.trigger2("ipad.organization.captureMap.mapMounted")},beforeUnmount(){m.Z.unmount(),m.Z.removeListener("zoneClick",this.onZoneClick),m.Z.removeListener("mapClick",this.onMapClick),m.Z.removeListener("mapMove",this.onMapClick),m.Z.removeListener("mapChangeZoomLevel",this.onMapClick),m.Z.removeListener("zoneHovered",this.onZoneHovered),v.TB.$off("clearBuilded"),v.TB.$off("updateZonesChunk"),v.TB.$off("updateZone"),v.TB.$off("cancelAttack"),v.TB.$off("clearBuilded"),this.familyZonesBuild={},clearInterval(this.secondInterval)},data(){return{fightTimeLeft:0,notificationsExpanded:!1,timersLocal:{attackKD:-1,defenseKD:-1,underAttackTime:-1},modal:null,modalData:{},page:null,pageData:{},currentZone:null,editorMode:!1,timeLabels:[],pointMenu:{},zoneInfoModal:{},labelDrawed:!1,loaded:!1,sabotageMode:!1,selectedSabotageZoneId:null,sabotageZoneType:null,gangTimeLabels:[],gangMapZones:[],mapLabels:[],familyZonesBuild:{},renderLabels:!0,ownedZones:0,hasSputnik:[],hasLaboratory:[]}},methods:{...(0,i.nv)({back:"ipad/organization/back"}),getOwnedZones(){return(this.ownedZones/this.zonesAmount*100).toFixed(3)},roundNumber(t,e){var a=Math.pow(10,e),i=Math.round(t*a)/a;return i},onSecond(){this.timersLocal.attackKD=this.fight.attackPlusEndTime-this.getServerTimeWithOffset(),this.timersLocal.defenseKD=this.fight.defencePlusEndTime-this.getServerTimeWithOffset(),this.selfAction?this.timersLocal.underAttackTime=this.selfAction.startTime-this.getServerTimeWithOffset():this.timersLocal.underAttackTime=-1;let t=!1;if(this.isFamily)for(const e of this.timeLabels){const a=Math.floor((e.startTime-this.getServerTimeWithOffset())/1e3);if(a>=0)m.Z.updateDynamicLabel({...e,text:(0,Z.q)(a)}),t=!0;else{if(!e.stopped){m.Z.removeDynamicLabelById(e.id);const t=e.id.split("-")[1],a=this.getZones()[t];a.block.type=-1,a.data.defaultBlock={type:-1},m.Z.updateZoneData2(a),m.Z.updateMap()}e.stopped=!0}}if(!this.isFamily)for(const e of this.gangTimeLabels){const a=Math.floor((e.startTime-this.getServerTimeWithOffset())/1e3);if(a>=0)m.Z.updateDynamicLabel({...e,text:(0,Z.q)(a)}),t=!0;else{if(!e.stopped){m.Z.removeDynamicLabelById(e.id);const t=e.id.split("-")[1],a=this.gangMapZones[t-1];a.block.type=-1,a.data.defaultBlock={type:-1},m.Z.updateZoneData2(a),m.Z.updateMap()}e.stopped=!0}}t&&m.Z.updateMap()},createCapture(){this.setModal("set-capture",{zoneData:this.currentZone,isFamily:this.isFamily})},configureZone(){this.setModal("configure-zone",{zoneData:this.currentZone,isFamily:this.isFamily})},repaintZone(){this.setModal("attack",{type:"repaint-zone",zoneData:this.currentZone,isFamily:this.isFamily})},setModal(t,e={}){this.modal=t,this.modalData=e,t||this.onMapClick()},convertTime(t){let e=parseInt(t/1e3/60/60),a=parseInt(t/1e3/60%60),i=parseInt(t/1e3%60);return e=e<10?`0${e}`:e,a=a<10?`0${a}`:a,i=i<10?`0${i}`:i,`${e}:${a}:${i}`},dhm(t){const e=Math.floor(t/864e5),a=t%864e5,i=Math.floor(a/36e5),o=t%36e5,n=Math.floor(o/6e4),s=n>0,r=i>0,l=e>0;return l||r||s?(l?e+` ${this.$t("cef.ipad.org.captureMap.markerInfo.timeD")}`:"")+" "+(r?i+` ${this.$t("cef.ipad.org.captureMap.markerInfo.timeH")}`:"")+" "+(s?n+` ${this.$t("cef.ipad.org.captureMap.markerInfo.timeM")}`:""):this.$t("cef.gps.unknown")},calcTimeDiferenceToNow(t){const e=t-this.getServerTimeWithOffset();return e<=0?this.dhm(0):this.dhm(e)},setPage(t,e={}){this.page=t,this.pageData=e,t||this.onMapClick()},updateGangZonesMap(){m.Z.setDataLoaded(!1);const t=this.getZones(),e=this.playerFactionId,a=this.canEdit,i=[],o=[],n=[],s=[];if(!this.zonesGprah){const t=new L;this.fractionsZonesGraph={},this.zonesGprah=t}if(this.zonesGprah.verticesP.clear(),this.zonesGprah.adjacentListP.clear(),Array.isArray(t)&&t.forEach((t=>{this.zonesGprah.addVertex(parseInt(t.id),parseInt(t.factionId))})),Object.entries(g.AC).forEach((([t,e])=>{e.edges.forEach((e=>this.zonesGprah.addEdge(parseInt(t),parseInt(e))))})),g.N$.forEach((t=>this.fractionsZonesGraph[t]=this.buildFractionZonesGraph(this.zonesGprah,g.W1[t],t))),t?.length)for(let l=0;l<t?.length;l++){const a=t[l];if(a.factionId===e){this.ownedZones++;for(const i of y[l]){const o=t[i];o.factionId===e||a.action||o.action||s.includes(i)||s.push(i)}}}const r=65===t.filter((t=>!t.spawn&&t.factionId===e)).length;if(t?.length)for(let l=0;l<t?.length;l++){const d=t[l];let c=[...d.colorRgb],p={id:-1,scale:[.4,.4],position:[.5,.5]},f={type:-1},u=!1,h=[255,255,255,1];d.spawn&&(p.id=0,p.color=d.colorRgb,p.scale=[.4,.4],p.position=[.5,.5],h[3]=0),d.factionId!==e?(c[3]=.2,d.spawn||(h[3]=.6)):d.spawn||(f.type=0),d.factionId===e&&(c[3]=.5),d.textColorRgb&&(h=[...d.textColorRgb,h[3]]);const y=d.actionData,g=y&&y.type;let b=!1;if(s.includes(l)&&-1!==d.factionId){const e=t[l],a=this.getFractionZonesGraph(parseInt(e.factionId)),i=this.getFractionZonesGraph(parseInt(e.factionId),{owner:0,vertexId:parseInt(e.id)});a.length-i.length>1&&(b=!0)}const Z="string"!==typeof g&&d.factionId!==e&&(!d.spawn||r)&&s.includes(l)&&a&&!b;Z&&(u=!0),m.Z.removeDynamicLabelById(`timeLabel-${d.id}`),"string"===typeof g&&(y.startTime-this.getServerTimeWithOffset()<=0?(c=[193,46,46,.8],h[3]=0,f.type=-1,p.scale=[.5,.5],p.position=[.5,.5],p.color=[255,255,255],"1"===g?p.id=1:"2"===g?p.id=2:"3"===g&&(p.id=3)):(c=[193,46,46,.8],f.type=1,h[3]=0,n.push({id:`timeLabel-${d.id}`,color:[255,255,255],position:{...d.position,y:d.position.y-40},size:.4,startTime:y.startTime}),p.color=[255,255,255],"1"===g?(p.id=1,p.scale=[.4,.4],p.position=[.5,.35]):"2"===g?(p.id=2,p.scale=[.4,.4],p.position=[.5,.35]):"3"===g&&(p.id=3,p.scale=[.4,.4],p.position=[.5,.35]))),this.editorMode&&!y&&(u=!0),i.push({id:d.id,position:d.position,size:140,color:c,defaultColor:c,sprite:{...p},block:{...f},borderActive:u,data:{canAttack:Z,textColor:h,zoneColor:[...d.colorRgb],defaultSprite:{...p},defaultBlock:{...f},defaultBorderActive:u,spawn:d.spawn,factionId:d.factionId,action:y}}),o.push({id:`labelZone-${d.id}`,position:{...d.position},text:`${d.id}`,size:.5,color:[...h]})}for(const l of n){const t=Math.floor((l.startTime-this.getServerTimeWithOffset())/1e3);t>=0&&m.Z.updateDynamicLabel({...l,text:(0,Z.q)(t)})}this.gangTimeLabels=n,this.gangMapZones=i,m.Z.updateMap(),m.Z.updateLabelsList((0,D.toRaw)(o)),m.Z.updateZonesList(i),this.loaded=!0,m.Z.setDataLoaded()},updateZonesMap(){this.isFamily||this.updateGangZonesMap()},rebuildCanAttackMap(t){console.trace("rebuild!");const e=this.isFamily?this.playerFamilyId:this.playerFactionId,a=t=>t<=84||(t-1)%84==0||t%84==0||t>4789,i=(t,e,a)=>t-a+84*e,o=t=>[i(t,0,2),i(t,-1,2),i(t,-1,1),i(t,-1,0),i(t,-1,-1),i(t,0,-1),i(t,1,-1),i(t,2,-1),i(t,2,0),i(t,2,1),i(t,2,2),i(t,1,2)],n=e=>{const a=t.find((t=>t.id==e)),o=[i(e,0,2),i(e,-1,2),i(e,-2,2),i(e,-2,1),i(e,-2,0),i(e,-2,-1),i(e,-2,-2),i(e,-1,-2),i(e,0,-2),i(e,1,-2),i(e,2,-2),i(e,2,-1),i(e,2,0),i(e,2,1),i(e,2,2),i(e,1,2)],n=[];return o.forEach((e=>{const a=t.find((t=>t.id==e));a&&this.isFamily&&2==a.data.familyData.type&&n.push(e)})),this.isFamily&&0!=a.data.familyData.type&&1!=a.data.familyData.type?2==a.data.familyData.type?[i(e,0,2),i(e,-1,1),i(e,-1,0),i(e,0,-1),i(e,1,-1),i(e,2,0),i(e,2,1),i(e,1,2),...n]:void 0:[e-1,e+84,e+1,e-84,...n]},s=[];for(const r of t)if(this.isFamily&&r.data.familyId===e||r.familyId&&r.familyId==e){const e=n(r.id);e.forEach((e=>{const a=t.find((t=>t.id==e));!a||a.action||r.action||s.includes(e)||s.push(e)}))}for(const r of t){let e=!1,i=!0;if(this.isFamily&&r.data.familyData&&r.data.familyData.type&&2==r.data.familyData.type){const e=o(r.id),a=[];e.forEach((e=>{const i=t.find((t=>t.id==e));i&&i.data&&(i.data.familyId!=this.playerFamilyId||a.includes(e)||a.push(e))})),a.length<7&&!this.sabotageMode&&(i=!1)}const n=this.isFamily&&r.data.familyId!=this.playerFamilyId&&(a(r.id)||s.includes(r.id))&&"string"!==typeof actionType&&this.canEdit&&(!this.isFamily||0==r.data.familyData.type||this.ownedZones>=20)&&this.isFamily&&i;if(n&&!this.sabotageMode&&(e=!0),this.editorMode&&!r.data.action&&(e=!0),r.data.action&&(e=!1),r.disableSabotage=!1,this.isFamily&&this.sabotageMode&&702==this.sabotageZoneType&&(r.data.familyId!==this.playerFamilyId||r.data.familyData&&!r.data.familyData.subType||r.data.debuffData)){r.color=[r.defaultColor[0],r.defaultColor[1],r.defaultColor[2],0],r.sprite.color=[255,255,255,0],r.sprite.id=-1,r.block.type=-1,e=!1;const t=[...r.data.textColor];t[3]=0,r.disableSabotage=!0,m.Z.updateLabelColorById(`labelZone-${r.id}`,t)}else if(!this.isFamily||!this.sabotageMode||703!=this.sabotageZoneType||r.data.familyId!=this.playerFamilyId&&r.data.canAttack&&!r.data.debuffData&&r.data.familyId&&r.data.familyData.type){const{defaultSprite:t,defaultBlock:a,textColor:i}=r.data;r.color=r.defaultColor,r.sprite={...t},r.block.type=a.type;const o=[...i];!n||r.data.action||[1,2].includes(r.data.familyData.type)||(o[3]=.3,r.color[3]=.2),n&&!r.data.action&&[1,2].includes(r.data.familyData.type)&&(e=!0),o[3]=r.data.action?0:o[3],m.Z.updateLabelColorById(`labelZone-${r.id}`,o)}else{r.color=[r.defaultColor[0],r.defaultColor[1],r.defaultColor[2],0],r.sprite.color=[255,255,255,0],r.sprite.id=-1,r.block.type=-1,e=!1;const t=[...r.data.textColor];t[3]=0,r.disableSabotage=!0,m.Z.updateLabelColorById(`labelZone-${r.id}`,t)}r.borderActive=e,r.data.canAttack=n,r.data.defaultBorderActive=e}},getServerTimeWithOffset(){return new Date(Date.now()+this.serverTimeOffset)},onZoneHovered(t,e){if(t.data.action&&!this.sabotageMode)return t.color=e?[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],1]:t.defaultColor,m.Z.updateZoneData(t),void m.Z.updateMap();if(this.editorMode){if(t.data.action)return;if(e){t.borderActive=!1,t.color=[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],1],t.sprite.id=4,t.sprite.color=[255,255,255,255],t.sprite.position=[.5,.5],t.sprite.scale=[.4,.4],t.block.type=-1;const e=[...t.data.textColor];e[3]=0,m.Z.updateLabelColorById(`labelZone-${t.id}`,e)}else{t.borderActive=!0,t.color=t.defaultColor;const{defaultSprite:e,defaultBlock:a,textColor:i}=t.data;t.sprite={...e},t.block.type=a.type,m.Z.updateLabelColorById(`labelZone-${t.id}`,i)}return m.Z.updateZoneData(t),void m.Z.updateMap()}if(this.sabotageMode){if(t.data.action)return;const a=702==this.sabotageZoneType?t.data.familyId==this.playerFamilyId:t.data.familyId!=this.playerFamilyId;if(e&&-1!=t.sprite.id&&a){t.borderActive=!1,t.color=[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],1],t.sprite.id=702==this.sabotageZoneType?47:48,t.sprite.color=[255,255,255,255],t.sprite.position=[.5,.5],t.sprite.scale=[.4,.4],t.block.type=-1;const e=[...t.data.textColor];e[3]=0,m.Z.updateLabelColorById(`labelZone-${t.id}`,e)}else if(-1!=t.sprite.id&&a){t.color=t.defaultColor;const{defaultSprite:e,defaultBlock:a,textColor:i}=t.data;t.sprite={...e},t.block.type=a.type,m.Z.updateLabelColorById(`labelZone-${t.id}`,i)}return m.Z.updateZoneData(t),void m.Z.updateMap()}if(t.data.familyData&&0!==t.data.familyData.type)return e?(t.borderActive=!1,t.color=[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],.6]):(t.borderActive=t.data.canAttack,t.color=t.defaultColor),m.Z.updateZoneData(t),void m.Z.updateMap();if(t.data.canAttack){if(t.data.spawn)e?(t.borderActive=!1,t.color=[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],1],t.sprite.id=1,t.sprite.color=[255,255,255]):(t.borderActive=!0,t.color=t.defaultColor,t.sprite.id=0,t.sprite.color=t.data.zoneColor,t.sprite.scale=[.4,.4],t.sprite.position=[.5,.5]);else if(e)if(t.data.familyData&&"special"===t.data.familyData.type)t.borderActive=!1,t.color=[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],.5];else{t.borderActive=!1,t.color=[t.defaultColor[0],t.defaultColor[1],t.defaultColor[2],1],t.sprite.id=1;const e=[...t.data.textColor];e[3]=0,m.Z.updateLabelColorById(`labelZone-${t.id}`,e)}else if(t.data.familyData&&"special"===t.data.familyData.type);else{t.borderActive=!0,t.color=t.defaultColor,t.sprite.id=-1;const e=[...t.data.textColor];t.data.action||(e[3]=.3,t.color[3]=.2),m.Z.updateLabelColorById(`labelZone-${t.id}`,e)}return m.Z.updateZoneData(t),void m.Z.updateMap()}},onZoneClick(t,e,a,i,o){if(this.onMapClick(),this.currentZone=t,!this.sabotageMode||!t.disableSabotage){if(this.editorMode){const e=t.data.action?this.$refs.contextMenuEdit:this.$refs.contextMenuAdmin;return e===this.$refs.contextMenuEdit&&(this.pointMenu={isInfoModal:!1,attackerId:t.data.action.attackerId,defenderId:t.data.action.defenderId,attacker:this.isFamily?t.data.action.attackerName:(0,M.V)(t.data.action.attackerId),defender:this.isFamily?t.data.familyName||this.$t("cef.ipad.org.captureMap.markerInfo.neutral"):(0,M.V)(t.data.action.defenderId),start:t.data.action.startTime,participants:t.data.action.peopleCount,caliber:t.data.action.caliberLabel,buttonsTimeActive:t.data.action.startTime-12e4>this.getServerTimeWithOffset()}),void(e&&(e.style.left=`${i}px`,e.style.top=`${o}px`,e.style.opacity=1,e.style.pointerEvents="auto"))}if(t.data.action&&!this.sabotageMode)return this.pointMenu={attackerId:t.data.action.attackerId,defenderId:t.data.action.defenderId,attacker:this.isFamily?t.data.action.attackerName:(0,M.V)(t.data.action.attackerId),defender:this.isFamily?t.data.familyName||this.$t("cef.ipad.org.captureMap.markerInfo.neutral"):(0,M.V)(t.data.action.defenderId),start:t.data.action.startTime,participants:t.data.action.peopleCount,caliber:t.data.action.caliberLabel,buttonsTimeActive:t.data.action.startTime-12e4>this.getServerTimeWithOffset()},void(this.$refs.contextMenuEdit&&(this.$refs.contextMenuEdit.style.left=`${i}px`,this.$refs.contextMenuEdit.style.top=`${o}px`,this.$refs.contextMenuEdit.style.opacity=1,this.$refs.contextMenuEdit.style.pointerEvents="auto"));if(t.data.familyData&&this.isAdmin&&0==t.data.familyData.type&&!t.data.canAttack&&!t.data.action){const e=this.$refs.contextMenuEdit;return this.pointMenu={isAdminModal:!0,id:`${t.id}`,owner:`${t.data.familyName}`,ownerId:t.data.familyId},e.style.left=`${i}px`,e.style.top=`${o}px`,e.style.opacity=1,void(e.style.pointerEvents="auto")}if(t.data.familyData&&t.data.familyData.type){const e=this.$refs.contextMenuEdit;return this.pointMenu={isInfoModal:!0,id:`${t.id}`,canAttack:t.data.canAttack,zoneSubtype:t.data.familyData.subType,zoneType:t.data.familyData.type,owner:`${t.data.familyName}`,level:this.getLevel(t),ownerId:t.data.familyId,description:this.$t(`cef.ipad.org.captureMap.familyMap.desc.${t.data.familyData.buffName}`),name:this.$t(`cef.ipad.org.captureMap.familyMap.name.${t.data.familyData.buffName}`),hasLabBuff:this.hasExtraLevelZoneControlled.length,hasExtraLevel:!!t.data.familyData.levelsConfig&&6==t.data.familyData.levelsConfig.length,useTrans:t.data.familyData.useTrans},t.data.familyData.levelsConfig&&(this.pointMenu.levelsConfig=t.data.familyData.levelsConfig.map((t=>({value:t.value,viewTitle:`cef.ipad.org.captureMap.familyMap.levelItems.${t.viewTitle}`}))),this.pointMenu.levelTitle=this.$t(`cef.ipad.org.captureMap.familyMap.levelTitle.${t.data.familyData.levelTitle||"default"}`),this.pointMenu.levelViewType=t.data.familyData.levelViewType),t.data.familyData.extraDefence&&(this.pointMenu.extraDefence=this.$t("cef.ipad.org.captureMap.familyMap.notify.extraDefence",{amount:t.data.familyData.extraDefence})),t.data.familyData.maxPerFraction&&(this.pointMenu.maxPerFraction=this.$t("cef.ipad.org.captureMap.familyMap.notify.onePerFraction",{amount:t.data.familyData.maxPerFraction})),t.data.familyData.overtakeReduse,t.data.familyData.require&&(this.pointMenu.require=t.data.familyData.require),t.data.familyData.requirePerks&&(this.pointMenu.requirePerks=t.data.familyData.requirePerks),t.data.familyData.itemsInfo&&(this.pointMenu.itemsInfo=t.data.familyData.itemsInfo),t.data.familyData.controllStartTime&&t.data.familyId==this.playerFamilyId&&(this.pointMenu.controllStartTime=t.data.familyData.controllStartTime),t.data.action&&(this.pointMenu.buttonsTimeActive=t.data.action.startTime-12e4>this.getServerTimeWithOffset(),this.pointMenu.attackerId=t.data.action.attackerId,this.pointMenu.defenderId=t.data.action.defenderId,this.pointMenu.attacker=this.isFamily?t.data.action.attackerName:(0,M.V)(t.data.action.attackerId),this.pointMenu.defender=this.isFamily?t.data.familyName||this.$t("cef.ipad.org.captureMap.markerInfo.neutral"):(0,M.V)(t.data.action.defenderId),this.pointMenu.start=t.data.action.startTime,this.pointMenu.participants=t.data.action.peopleCount,this.pointMenu.caliber=t.data.action.caliberLabel),C.includes(this.pointMenu.zoneSubtype)&&(this.pointMenu.sabotageData={},this.pointMenu.sabotageData.effectCooldown=t.data.effectCooldown,this.pointMenu.sabotageData.mapChunkId=1),t.data.debuffData&&Date.now()<t.data.debuffData.endTime&&(this.pointMenu.debuffData={endTime:t.data.debuffData.endTime,debuffType:t.data.debuffData.debuffType}),t.data.familyData&&this.getBizzBuffs().includes(t.data.familyData.subType)&&(this.pointMenu.bizzBuff=t.data.familyData.level),!this.sabotageMode||t.data.action||t.disableSabotage||(702==this.sabotageZoneType&&(this.pointMenu.sabotageAviable=t.data.familyId==this.playerFamilyId),703==this.sabotageZoneType&&(this.pointMenu.sabotageAviable=t.data.familyId!=this.playerFamilyId&&t.data.canAttack&&t.data.familyId)),e.style.left=`${i}px`,e.style.top=`${o}px`,e.style.opacity=1,void(e.style.pointerEvents="auto")}t.data.canAttack&&this.setPage("set-capture",{editMode:!1})}},onMapClick(){this.currentZone=null,this.$refs.contextMenuEdit&&(this.$refs.contextMenuEdit.style.opacity=0,this.$refs.contextMenuEdit.style.pointerEvents="none"),this.$refs.contextMenuAdmin&&(this.$refs.contextMenuAdmin.style.opacity=0,this.$refs.contextMenuAdmin.style.pointerEvents="none")},getLevelsConfig(t){const e=this.getZones()[t];if(e)return 5==this.getLevel(e)||6==e.data.familyData.levelsConfig.length&&this.hasLaboratory.length&&e.data.familyId&&e.data.familyId==this.playerFamilyId?e.data.familyData.levelsConfig:6==e.data.familyData.levelsConfig.length?e.data.familyData.levelsConfig.slice(0,5):e.data.familyData.levelsConfig},getLevel(t){const e=!!this.hasSputnik.length&&this.hasSputnik[0],a=e&&19!=t.data.familyData.subType&&t.data.familyId==this.playerFamilyId;return(0,Z.u)(t.data.familyData.level+(a?this.getZones()[this.hasSputnik[0]].data.familyData.level+1:0),0,this.hasLaboratory.length?5:4)},getLevelBizz(t){if(t.data.familyData&&this.getBizzBuffs().includes(t.data.familyData.subType))return t.data.familyData.level},getBizzBuffs(){return[100,101,102,103,104,105,106,107,108]},onEditCapture(){!this.currentZone||this.currentZone.data.action.startTime-12e4<=this.getServerTimeWithOffset()||this.setPage("set-capture",{editMode:!0})},setPageCapture(){this.setPage("set-capture",{editMode:!0})},onDiscardCapture(){!this.currentZone||this.currentZone.data.action.startTime-12e4<=this.getServerTimeWithOffset()||(mp.trigger2("ipad.organization.captureMap.discardAttack",this.currentZone.id,this.isFamily),this.onMapClick())},toggleEditorMode(){if(this.editorMode=!this.editorMode,!this.isFamily)return this.updateZonesMap(1);const t=Object.values(this.getZones());this.rebuildCanAttackMap(t),m.Z.updateZonesList(t),m.Z.updateMap()},toggleSabotageMode(){if(this.sabotageMode=!this.sabotageMode,this.sabotageMode?(this.selectedSabotageZoneId=this.pointMenu.id||null,this.sabotageZoneType=this.pointMenu.zoneSubtype):(this.selectedSabotageZoneId=null,this.sabotageZoneType=null),this.onMapClick(),!this.isFamily)return this.updateZonesMap(1);const t=Object.values(this.getZones());this.rebuildCanAttackMap(t),m.Z.updateZonesList(t),m.Z.updateMap()},saveConfig(){mp.trigger2("ipad.organization.captureMap.saveConfig")},processSaborageClient(){mp.trigger2("ipad.organization.captureMap.processEffect",parseInt(this.selectedSabotageZoneId),this.pointMenu.id),this.toggleSabotageMode()},toggleFreezeAttacks(){mp.trigger2("ipad.organization.captureMap.freezeZones",this.isFamily)},onLookAtSelfAction(){this.loaded&&this.selfAction&&"number"===typeof this.selfAction.zoneId&&m.Z.lookAtZone(this.selfAction.zoneId,7)},buildFractionZonesGraph(t,e,a){const i=[];return k(t,e,a,(t=>i.push(t.vertex))),i},getFractionZonesGraph(t,e=null){if(!e)return this.fractionsZonesGraph[t];const a=new L,{adjacentList:i,vertices:o}=this.zonesGprah.getCloneData();a.setCloneData(i,o);const{owner:n,vertexId:s}=e;a.editVertexOwner(s,n);const r=this.buildFractionZonesGraph(a,g.W1[t],t);return r},getTimeToLvlUp(t){const e=Object.values(this.getZones()).find((e=>e.id==t));if(!e)return;const a=this.getLevel(e),i=e.data.familyData.levelsConfig.length,o=this.hasExtraLevelZoneControlled.length,n=e.data.familyData.controllStartTime;if(0==i||a+1==i||a+2==i&&!o&&6==i)return;const s=a+1,r=24*s*60*60*1e3,l=24*a*60*60*1e3,d=n+l+r;return d-Date.now()+this.getServerTimeWithOffset().getMilliseconds()},wrap(t){const e=this.getTimeToLvlUp(t);return e},getZones(){return console.log("getZones",this.isFamily,this.familyZonesBuild,this.gangZonesMap),this.isFamily?this.familyZonesBuild:this.gangZonesMap},getMaxAttacks(){return this.isFamily?this.maxAttacks:3},getMaxDefences(){return this.isFamily?this.maxDefences:3},updateZoneAndApplyStyle(t){},applyCanAttack(){},applyHovered(){},applySabotageMode(){},applyAction(t){},processZonesUpdate(t){const e=this.playerFamilyId,a=[];for(let i=0;i<t.length;i++){const o=t[i];let n=[...o.colorRgb],s={id:-1,scale:[.4,.4],position:[.5,.5]},r={type:-1},l=!1,d=z(n,1);const c=o.actionData,p=c&&c.type,f=!1;let u=f?.2:.1,h=f?.2:.1;if(2===o.zoneType&&(s.id=o.icon,s.color=[255,255,255],s.scale=[.3,.3],o.size=280,l=!1,h=o.familyId===e?.4:.2,n[3]=o.familyId===e?.4:.2),1===o.zoneType&&(s.id=o.icon,s.color=[255,255,255],s.scale=[.35,.35],s.position=[.5,.3],h=o.familyId===e?.4:.2,l=!1,n[3]=o.familyId===e?.4:.2),0===o.zoneType&&(o.familyId===e&&(u=.4,r.type=0),n=[n[0],n[1],n[2],u]),o.familyId===e&&(h=1),o.debuffData&&o.debuffData.endTime-new Date(this.getServerTimeWithOffset())>0){let t;switch(r.type=4,o.debuffData.debuffType){case 701:t=34;break;case 702:t=47;break;case 703:t=48;break}s.id=t||s.id}if(m.Z.removeDynamicLabelById(`timeLabel-${o.id}`),this.timeLabels=this.timeLabels.filter((({id:t})=>t!=`timeLabel-${o.id}`)),"string"===typeof p){if(c.startTime-new Date(this.getServerTimeWithOffset())<=0)n=[193,46,46,.8],d[3]=0,r.type=-1,s.scale=[.5,.5],s.position=[.5,.5],s.color=[255,255,255],"attack"===p?s.id=1:"defence"===p?s.id=2:"anotherAttack"===p&&(s.id=3);else{n=[193,46,46,.8],r.type=1,d[3]=0;const t=2==o.zoneType;a.push({id:`timeLabel-${o.id}`,color:[255,255,255],position:t?{...o.position,y:o.position.y-80}:{...o.position,y:o.position.y-40},size:t?.8:.4,startTime:c.startTime}),s.color=[255,255,255],"attack"===p?(s.id=1,s.scale=[.4,.4],s.position=[.5,.35]):"defence"===p?(s.id=2,s.scale=[.4,.4],s.position=[.5,.35]):"anotherAttack"===p&&(s.id=3,s.scale=[.4,.4],s.position=[.5,.35])}l=!1}c||(d=z(n,h),d[3]=h);const y={id:o.id,position:o.position,size:o.size||140,color:n,defaultColor:n,sprite:{...s},block:{...r},borderActive:l,data:{canAttack:f,label:o.label,familyName:o.familyName,textColor:d,zoneColor:[...o.colorRgb],defaultSprite:{...s},defaultBlock:{...r},defaultBorderActive:l,spawn:o.spawn,factionId:o.factionId,familyId:o.familyId,action:c,debuffData:o.debuffData,effectCooldown:o.effectCooldown,familyData:{type:o.zoneType,subType:o.zoneSubtype,level:o.level,description:o.description,levelsConfig:o.levelsConfig,buffName:o.buffName,levelViewType:o.levelViewType,levelTitle:o.levelTitle,overtakeReduse:o.overtakeReduse,maxPerFraction:o.maxPerFraction,extraDefence:o.extraDefence,controllStartTime:o.controllStartTime,useTrans:o.useTrans,require:o.require,requirePerks:o.requirePerks,itemsInfo:o.itemsInfo}}},g=this.familyZonesBuild[o.id];g||(0===o.zoneType&&this.mapLabels.push({id:`labelZone-${o.id}`,position:{...o.position},text:`${o.label||o.id}`,size:.5,color:c?[d[0],d[1],d[2],0]:[d[0],d[1],d[2],h]}),1===o.zoneType&&this.mapLabels.push({id:`labelZone-${o.id}`,position:{x:o.position.x,y:o.position.y-28,z:o.position.z},text:`${o.label||o.id}`,size:.5,color:c?[d[0],d[1],d[2],0]:[d[0],d[1],d[2],h]}),o.familyId==e&&this.ownedZones++),g&&(m.Z.updateLabelColorById(`labelZone--${o.id}`,d),m.Z.updateZoneData2(y),m.Z.updateMap()),17!=y.data.familyData.subType||this.hasLaboratory.includes(y.id)||y.data.familyId!=e||this.hasLaboratory.push(y.id),17==y.data.familyData.subType&&this.hasLaboratory.includes(y.id)&&y.data.familyId!=e&&(this.hasLaboratory=this.hasLaboratory.filter((t=>t!=y.id))),19!=y.data.familyData.subType||this.hasSputnik.includes(y.id)||y.data.familyId!=e||this.hasSputnik.push(y.id),19==y.data.familyData.subType&&this.hasSputnik.includes(y.id)&&y.data.familyId!=e&&(this.hasSputnik=this.hasSputnik.filter((t=>t!=y.id))),console.log(o.id,this.familyZonesBuild[o.id],y),this.familyZonesBuild[o.id]=y}for(const i of a){const t=Math.floor((i.startTime-this.getServerTimeWithOffset())/1e3);t>=0&&m.Z.updateDynamicLabel({...i,text:(0,Z.q)(t)})}if(this.timeLabels.push(...a),this.zonesAmount<=Object.keys(this.getZones()).length&&!this.loaded){m.Z.setDataLoaded(),this.loaded=!0;const t=Object.values(this.getZones());m.Z.updateLabelsList((0,D.toRaw)(this.mapLabels)),this.rebuildCanAttackMap(t),m.Z.updateZonesList(t),m.Z.updateMap()}}},computed:{...(0,i.rn)({organizationColorSchema:t=>t.ipad.colorSchema[t.ipad.openedApp],zoneControl:t=>t.ipad.organization.captureMap.zoneControl,fight:t=>t.ipad.organization.captureMap.fight,zonesData:t=>t.ipad.organization.captureMap.zonesData,gangZonesMap:t=>t.ipad.organization.captureMap.gangZonesMap,zonesChunk:t=>t.ipad.organization.captureMap.zonesChunk,lastUsedType:t=>t.ipad.organization.captureMap.lastUsedType,mapLabelsInfo:t=>t.ipad.organization.captureMap.mapLabelsInfo,timeLabelsToRemove:t=>t.ipad.organization.captureMap.timeLabelsToRemove,timeLabelsGangMap:{get(t){return t.ipad.organization.captureMap.timeLabelsGangMap},set(t,e){t.ipad.organization.captureMap.timeLabelsGangMap=e}},mapLabelsToRemove:t=>t.ipad.organization.captureMap.mapLabelsToRemove,selfAction:t=>t.ipad.organization.captureMap.selfAction,playerFactionId:t=>t.ipad.member,isAdmin:t=>t.ipad.organization.captureMap.isAdmin,canConfigureZone:t=>t.ipad.organization.captureMap.canConfigureZone,isFamily:t=>t.ipad.organization.captureMap.isFamily,freezeActive:t=>t.ipad.organization.captureMap.freezeActive,canEdit:t=>t.ipad.organization.captureMap.canEdit,hasExtraLevelZoneControlled:t=>t.ipad.organization.captureMap.hasExtraLevelZoneControlled,hasSputnikControlled:t=>t.ipad.organization.captureMap.hasSputnikControlled,maxAttacks:t=>t.ipad.organization.captureMap.maxAttacks,maxDefences:t=>t.ipad.organization.captureMap.maxDefences,defencesLog:t=>t.ipad.organization.captureMap.defencesLog,attacksLog:t=>t.ipad.organization.captureMap.attacksLog,zonesAmount:t=>t.ipad.organization.captureMap.zonesAmount,rebuildMap:t=>t.ipad.organization.captureMap.rebuildMap,showSaveBtn:t=>t.ipad.organization.captureMap.showSaveBtn,serverTimeOffset:t=>t.main.serverTimeOffset,playerFamilyId:t=>t.ipad.family,cefAcceleration:t=>t.ipad.organization.captureMap.cefAcceleration,server:t=>t.main.server}),...(0,i.Se)({notificationsCount:"ipad/organization/captureMap/notificationsCount"}),fightAttackExpanded(){return this.timersLocal.attackKD>0},fightDefenceExpanded(){return this.timersLocal.defenseKD>0},showUnderAttack(){return this.selfAction&&this.timersLocal.underAttackTime>0}},watch:{renderLabels(t){m.Z.toggleLabelRendering(t),m.Z.updateMap()},zonesData(t){this.updateZonesMap(t)},zonesChunk(t){},gangZonesMap(){this.isFamily||this.updateGangZonesMap()},canEdit(){this.updateZonesMap(2)},fight(){this.onSecond()},hasExtraLevelZoneControlled(){this.updateZonesMap()},cefAcceleration(){this.renderLabels=this.cefAcceleration}}};class L{constructor(){this.verticesP=new Set,this.adjacentListP=new Map}get vertices(){return Array.from(this.verticesP)}get adjacentList(){const t={};return this.adjacentListP.forEach(((e,a)=>{t[a]=Array.from(e)})),t}addVertex(t=null,e=null){this.verticesP.has(t)||null===t||void 0===t||(this.verticesP.add({vertex:t,owner:e}),this.adjacentListP.set(t,new Set))}addEdge(t=null,e=null){null!==t&&void 0!==t&&null!==e&&void 0!==e&&t!=e&&this.adjacentListP?.get(t)?.add(e)}editVertexOwner(t,e){if(null!==t){const a=this.vertices;this.verticesP.clear(),a.forEach((a=>a.vertex!=t?this.verticesP.add({vertex:a.vertex,owner:a.owner}):this.verticesP.add({vertex:a.vertex,owner:e})))}}getCloneData(){return{adjacentList:this.adjacentListP,vertices:this.verticesP}}setCloneData(t,e){this.adjacentListP=new Map(t),this.verticesP=new Set(e)}}const I=Object.freeze({GREEN:"green",YELLOW:"yellow",RED:"red"});function k(t,e,a,i){const{vertices:o,adjacentList:n}=t;if(0===o.length)return;const s=o.reduce(((t,e)=>({...t,[e.vertex]:I.GREEN})),{});function r(t){s[t.vertex]===I.GREEN&&t.owner==a&&(i&&i(t),s[t.vertex]=I.YELLOW,n[t.vertex].forEach((t=>r(o[t-1])))),s[t.vertex]=I.RED}s[e]=I.YELLOW,n[e].forEach((t=>{r(o[t-1])}))}const T=t=>{function e(t,e,a,i="rgb_channels"){const o=h()(t),n=o.isLight()?h()(a):h()(e);switch(i){case"rgb_channels":return`${n.color[0]}, ${n.color[1]}, ${n.color[2]}`;case"rgb":return n;default:return`${n.color[0]}, ${n.color[1]}, ${n.color[2]}`}}const a=(t,e,a)=>"#"+(1<<24|t<<16|e<<8|a).toString(16).slice(1),i=e(a(t[0],t[1],t[2]),"#fbfbfb","#060606","rgb");return[i.red(),i.green(),i.blue()]},z=(t,e)=>{function a(t,e,a){var i=t*a,o=e*(1-a);return parseInt(i+o)}function i(t,e,i){var o=a(t[0],e[0],i),n=a(t[1],e[1],i),s=a(t[2],e[2],i);return{r:o,g:n,b:s}}const o=[46,46,46];return T([...Object.values(i(t,o,e))])}}}]);